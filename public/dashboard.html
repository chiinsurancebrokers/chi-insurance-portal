<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CHI Insurance Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-shield-check"></i> CHI Insurance Portal
            </a>
            <div class="ms-auto">
                <span class="navbar-text text-white me-3" id="client-name"></span>
                <button class="btn btn-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Αποσύνδεση
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <h2 class="mb-4">Dashboard</h2>
        
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <h6 class="text-muted">Σύνολο Πολιτικών</h6>
                        <h3 id="total-policies">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h6 class="text-muted">Ενεργές Πολιτικές</h6>
                        <h3 id="active-policies">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h6 class="text-muted">Εκκρεμείς Πληρωμές</h6>
                        <h3 id="pending-payments">-</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Επερχόμενες Λήξεις</h5>
            </div>
            <div class="card-body">
                <div id="pending-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }
        
        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                
                document.getElementById('client-name').textContent = data.client.name;
                document.getElementById('total-policies').textContent = data.stats.total_policies;
                document.getElementById('active-policies').textContent = data.stats.active_policies;
                document.getElementById('pending-payments').textContent = data.stats.pending_payments;
                
                const pendingList = document.getElementById('pending-list');
                if (data.pending_payments.length === 0) {
                    pendingList.innerHTML = '<p class="text-muted">Δεν υπάρχουν εκκρεμείς πληρωμές</p>';
                } else {
                    let html = '<table class="table"><thead><tr><th>Πολιτική</th><th>Πινακίδα</th><th>Ποσό</th><th>Λήξη</th><th>Κατάσταση</th></tr></thead><tbody>';
                    
                    data.pending_payments.forEach(p => {
                        let badgeClass = 'bg-info';
                        if (p.days_until <= 0) badgeClass = 'bg-danger';
                        else if (p.days_until <= 3) badgeClass = 'bg-danger';
                        else if (p.days_until <= 7) badgeClass = 'bg-warning text-dark';
                        
                        html += `<tr>
                            <td>${p.policy_type}</td>
                            <td>${p.license_plate || '-'}</td>
                            <td>€${p.amount.toFixed(2)}</td>
                            <td>${p.due_date}</td>
                            <td><span class="badge ${badgeClass}">${p.days_until} ημέρες</span></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    pendingList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
        
        loadDashboard();
    </script>
</body>
</html>
